---
title: "Nutrient Analysis"
author: "Callie Stephenson"
date: "2024-12-03"
output: html_document
editor_options: 
  chunk_output_type: console
---
# Set-up

load libraries
```{r}
library(dplyr)
library(car)
library(ggplot2)
library(fishualize)
library(corrplot)
library(PerformanceAnalytics)
library(performance)
library(MuMIn)
library(ggeffects)
library(lmerTest)
library(glmnet)
library(ggstats)
```

ggplot theme
```{r}
custom_theme <- theme_minimal(base_size = 10)+
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10)
  )
```

load data
```{r}
response_data <- read.csv("data/response_data.csv")
explanatory_variables <- read.csv("data/explanatory_variables.csv") %>% 
  select(!pc1)
all_nut <- read.csv("data/All_Nutrients_Processed.csv")
```

# PCA
Remove seep:
```{r}
nut_no_seep <- all_nut[all_nut$CowTagID != 'VSEEP',]
pulse_columns <- names(all_nut)[grepl("Low_Tide_Mean_", names(all_nut)) & 
                            !grepl("Temperature|Ammonia_umol|NNP",names(all_nut))]
nut_no_seep_scaled <- nut_no_seep %>%
  mutate(across(all_of(pulse_columns), scale))
```

Look at correlation between variables:
```{r}
pulse_df <- as.data.frame(lapply(nut_no_seep_scaled[, c(pulse_columns)], as.numeric))
cor_matrix <- cor(pulse_df)
corrplot(cor_matrix, method = "number")
chart.Correlation(pulse_df)
```

PCA:
```{r}
pca.data <- na.omit(nut_no_seep_scaled[, c(pulse_columns)]) 
pca = princomp(pca.data, cor=TRUE)
```

When we make a PCA of 
```{r}
names(pca.data)
```

we can explain 67.5% of the variation of these factors with 1 axis. 
```{r}
summary(pca)
loadings(pca)
```

```{r}
biplot(pca)
```

```{r autoplot}
# pca_plot <- autoplot(pca, loadings = TRUE, loadings.colour = '#47c16e',
#                       loadings.label = TRUE, loadings.label.size = 3, loadings.label.colour = '#47c16e') +
#  labs(
#     title = "Principal Component Analysis of Nutrient Data",
#     x = "Principal Component 1 (72.249%)",
#     y = "Principal Component 2 (15.019%)"
#   ) +
#   xlim(-2.5,4)+
# #  scale_x_reverse(-0.5,0.5) +
#   theme_minimal(base_size = 15) +  # Clean theme
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),  # Center title
#     axis.title = element_text(size = 12)
#   )
# 
# pca_plot
#ggsave(pca_plot, filename = "PCA_Plot.png", dpi = 600, width = 7, height = 5)
```

```{r}
#derive scores and loadings from the pca
scores <- as.data.frame(pca$scores)
loadings <- as.data.frame(pca$loadings[, 1:2])  # Using only the first two components to make a 2d plot

# Loadings scaled using eigenvalues to match biplot behavior
scale_factor <- max(abs(scores$Comp.1), abs(scores$Comp.2))

loadings <- loadings * scale_factor  # Rescale loadings by the same factor as scores

# Plot with flipped x-axis and matching scales
pca_plot <- ggplot(scores, aes(x = -Comp.1, y = Comp.2)) +
  geom_point() +
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = -Comp.1, yend = Comp.2),
               arrow = arrow(length = unit(0.2, "cm")), color = '#084439') +
  geom_text(data = loadings, aes(x = -Comp.1, y = Comp.2, label = rownames(loadings)),
            color = '#084439', hjust = -0.2) +
  labs(
    title = "Principal Component Analysis of SGD-related Water Quality Parameters \n",
    x = "Principal Component 1",
    y = "Principal Component 2"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
    axis.title = element_text(size = 12)
  ) +
  scale_x_continuous(limits = c(-5, 5)) +
  scale_y_continuous(limits = c(-3, 3))

pca_plot
#ggsave(pca_plot, filename = "output/PCA_Plot.png", dpi = 600, width = 10, height = 6)
```

```{r}
nut_no_seep_scaled$pc1 = -1*(pca$scores[,1]) #what's this data's score on pc1 axis
nut_no_seep_scaled$pc2 = (pca$scores[,2]) #what's this data's score on pc1 axis
```

```{r}
nut_no_seep$pc1 = -1*(pca$scores[,1]) #don't forget to flip it!
```


```{r}
explanatory_variables_with_pc <- nut_no_seep[,c("CowTagID", "pc1", pulse_columns)]

pc1_df <- left_join(explanatory_variables_with_pc[,c("CowTagID", "pc1")], response_data[,c("CowTagID", "Pin_Number")]) %>% distinct()
#write.csv(pc1_df, "data/pc1.csv")
#write.csv(explanatory_variables, "data/pc1.csv")
```

model data
```{r}
model_data <- left_join(response_data, explanatory_variables_with_pc, by = join_by(CowTagID))

PAC_model_data <- model_data %>%
  filter(Species == "Pocillopora acuta", !is.na(Pin_Number))


PAC_model_data_caged_only <- PAC_model_data %>% 
  filter(Cage_Uncaged == "C")

PRU_model_data <- model_data %>%
  filter(Species == "Porites rus", !is.na(Pin_Number)) %>% 
  mutate(Percent_Change = if_else(Placement_Code == "PRU V13 A", NA_real_, Percent_Change))

PRU_model_data_caged_only <- PRU_model_data %>% 
  filter(Cage_Uncaged == "C")
```

# Growth

## P. acuta

### plot raw
```{r}
pac_growth_raw <- ggplot(PAC_model_data, aes(x = pc1, y = Percent_Change, color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(
    x = "PC1",
    y = "Percent Change in Buoyant Weight",
    title = " "
    #title = expression(italic("Pocillopora acuta") ~ "Change in Buoyant Weight by Nutrient Pulses")
  ) +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pac_growth_raw

#ggsave("output/pac_growth_nutrientpca_raw.png",pac_growth_raw, height = 5, width = 5.5)
```

### linear
```{r}
linear_growth_model_pac <- lmerTest::lmer(Percent_Change ~ pc1 +
                                  (1|Genotype), data = PAC_model_data)
#check_model(linear_growth_model_pac)
#summary(linear_growth_model_pac)
Anova(linear_growth_model_pac)
```

This model does not support the hypothesis that nutrients from SGD contribute to the variance in calcification in Pocillopora acuta


### polynomial model: 

```{r}
polynomial_growth_model_pac <- lmer(log10(Percent_Change) ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(polynomial_growth_model_pac)
Anova(polynomial_growth_model_pac)
```

This model does not support the hypothesis that nutriencts from SGD contribute to the variance in calcification in Pocillopora acuta

## P. rus

### plot raw
```{r}
pru_growth_raw <- ggplot(PRU_model_data, aes(x = pc1, y = Percent_Change, color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PC1", y = "Percent Change in Buoyant Weight", title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pru_growth_raw
ggsave("output/pru_growth_nutrientpca_raw.png",pru_growth_raw, height = 5, width = 5.5)
```


### linear
```{r}
linear_growth_model_pru <- lmerTest::lmer(Percent_Change ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(linear_growth_model_pru)
Anova(linear_growth_model_pru)
#summary(linear_growth_model_pru)
```

We do not find support for pc1 affecting growth of Porites rus in a linear fashion

### polynomial
```{r}
polynomial_growth_model_pru <- lmer(Percent_Change ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(polynomial_growth_model_pru)
Anova(polynomial_growth_model_pru)
```
We do not find support for pc1 affecting growth of Porites rus in a polynomial fashion

## Caged only

I also ran these models on a dataset with only caged corals:
### PAC
#### linear
```{r}
linear_growth_model_PAC_c <- lmer(Percent_Change ~ pc1 +
                                  (1|Genotype), data = PAC_model_data_caged_only)
#check_model(linear_growth_model_PAC_c)
Anova(linear_growth_model_PAC_c)
```

#### polynomial
```{r}
polynomial_growth_model_PAC_c <- lmer(Percent_Change ~ poly(pc1, 2) +
                                  (1|Genotype), data = PAC_model_data_caged_only)
#check_model(polynomial_growth_model_PAC_c)
Anova(polynomial_growth_model_PAC_c)
```
### PRU

#### linear
```{r}
linear_growth_model_pru_c <- lmer(Percent_Change ~ pc1 +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(linear_growth_model_pru_c)
Anova(linear_growth_model_pru_c)
```

#### polynomial
```{r}
polynomial_growth_model_pru_c <- lmer(Percent_Change ~ poly(pc1, 2) +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(polynomial_growth_model_pru_c)
Anova(polynomial_growth_model_pru_c)
```

These model does not support the hypothesis that water chemsitry parameters derived from SGD on this gradient contribute to the variance in calcification in Pocillopora acuta or Porites rus

# Symbiont Count

## Pocillopora acuta

### plot raw
```{r}
pac_symb_raw <- ggplot(PAC_model_data, aes(x = pc1, y = log10(FSC.Events_per_cm_2), color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PC1", 
       y = expression(paste("Endosymbiont density (cells ", 10^6, cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pac_symb_raw

ggsave("output/pac_symb_nutrientpca_raw.png",pac_symb_raw, height = 5, width = 5.5)
```

### linear model
```{r}
linear_symb_model_pac <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(linear_symb_model_pac)
Anova(linear_symb_model_pac)
```

This model does not support the hypothesis that nutriencts from SGD contribute to the variance in symbiont density in Pocillopora acuta

### polynomial model

```{r}
polynomial_symb_model_pac <- lmer(log10(FSC.Events_per_cm_2) ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(polynomial_symb_model_pac)
Anova(polynomial_symb_model_pac)
```

This model does not support the hypothesis that nutrients from SGD contribute to the variance in symbiont density in Pocillopora acuta

## Porites rus
```{r}
pru_symb_raw <- ggplot(PRU_model_data, aes(x = pc1, y = log10(FSC.Events_per_cm_2), color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PC1", 
       y = expression(paste("Endosymbiont density (cells ", 10^6, cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pru_symb_raw

ggsave("output/pru_symb_nutrientpca_raw.png",pru_symb_raw, height = 5, width = 5.5)
```

### linear model
```{r}
linear_symb_model_pac <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(linear_symb_model_pac)
Anova(linear_symb_model_pac)
```
### linear model:

```{r}
linear_symb_model_pru <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(linear_symb_model_pru)
Anova(linear_symb_model_pru)
```

We do not find support for pc1 affecting symb of Porites rus in a linear fashion

### polynomial model:

```{r}
polynomial_symb_model_pru <- lmer(log10(FSC.Events_per_cm_2) ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(polynomial_symb_model_pru)
Anova(polynomial_symb_model_pru)
```

We do not find support for pc1 affecting symb of Porites rus in a polynomial fashion

## Caged only
### P. acuta
#### linear

```{r}
linear_symb_model_PAC_c <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype), data = PAC_model_data_caged_only)
#check_model(linear_symb_model_PAC_c)
Anova(linear_symb_model_PAC_c)
```

#### polynomial
```{r}
polynomial_symb_model_PAC_c <- lmer(log10(FSC.Events_per_cm_2) ~ poly(pc1, 2) +
                                  (1|Genotype), data = PAC_model_data_caged_only)
#check_model(polynomial_symb_model_PAC_c)
Anova(polynomial_symb_model_PAC_c)
```
### P. rus
#### linear

```{r}
linear_symb_model_pru_c <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(linear_symb_model_pru_c)
Anova(linear_symb_model_pru_c)
```

#### polynomial
```{r}
polynomial_symb_model_pru_c <- lmer(log10(FSC.Events_per_cm_2) ~ poly(pc1, 2) +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(polynomial_symb_model_pru_c)
Anova(polynomial_symb_model_pru_c)
```

This model does not support the hypothesis that nutrients from SGD contribute to the variance in symbiont density in Porites rus or P. acuta
# Chlorophyll

## Pocillopora acuta
### check raw
```{r}
pac_chl_raw <- ggplot(PAC_model_data, aes(x = pc1, y = Chl_ug.cm.2, color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PC1", 
       y = expression(paste("Chlorophyll density (μg ", cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") +
  scale_y_continuous(limits = c(0,4.5))

pac_chl_raw

#ggsave("output/pac_chl_nutrientpca_raw.png",pac_chl_raw, height = 5, width = 5.5)
```


### Linear
```{r}
linear_chl_model_pac <- lmer(Chl_ug.cm.2 ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(linear_growth_model_pac)
Anova(linear_chl_model_pac)
```
#### Plot significant model


```{r}
#prediction
prediction_data <- data.frame(pc1 = seq(
  min(PAC_model_data$pc1),
  max(PAC_model_data$pc1),
  length.out = 100
))

# Add predicted values to the dataframe using the model without random effects
predictions <- predict(linear_chl_model_pac, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

#annnotations
anova_results <- car::Anova(linear_chl_model_pac)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_chl_model_pac)
marginal_r2 <- r2_values[1]  # Marginal R^2
conditional_r2 <- r2_values[2]
aic_value <- AIC(linear_chl_model_pac)

# Create the plot with the fitted line
pac_chl_MOD <-ggplot() +
  geom_point(aes(x = pc1, y = Chl_ug.cm.2, color = Genotype, shape = Cage_Uncaged), data = PAC_model_data) +
  labs(x = "PC1", 
       y = expression(paste("Chlorophyll density (μg ", cm^2, ")")),
      title = " ",
    color = "Genotype",
    shape = "Caging Treatment") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  #add in line and ribbon
  geom_line(data = prediction_data, aes(x = pc1, y = fit), color = "#21908c") +  # Add the fitted line
  geom_ribbon(data = prediction_data, aes(x = pc1, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c") +  
  #annotations
  annotate("text", y = 3.5, x = -4,
         label = paste("p =", round(p_values["pc1"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3)),
         hjust = 0, vjust = 0, size = 3) +
  theme_minimal() +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white"))

pac_chl_MOD
#ggsave("output/pac_chl_pca_mod.png", pac_chl_MOD, height = 7, width = 6)
```

#### Investigate Univariate Models
```{r}
# Define the data and random effects
random_effects <- "(1|Genotype) + (1|Cage_Uncaged)"

# Define the predictors
predictors <- c("Low_Tide_Mean_Salinity", "Low_Tide_Mean_NN_umolL", 
                "Low_Tide_Mean_Phosphate_umolL", "Low_Tide_Mean_Silicate_umolL", 
                "Low_Tide_Mean_TA", "Low_Tide_Mean_pH")

predictors <- pulse_columns

# Initialize a results dataframe
results <- data.frame(Variable = character(), 
                      P_Value = numeric(), 
                      Marginal_R2 = numeric(), 
                      Conditional_R2 = numeric(),
                      AIC = numeric(),
                      stringsAsFactors = FALSE)

# Loop through each predictor
for (variable in predictors) {
  # Construct the formula dynamically
  formula <- as.formula(paste("Chl_ug.cm.2 ~", variable, "+", random_effects))
  
  # Fit the model
  model <- lmer(formula, data = PAC_model_data)
  
  # Get the p-value from Anova()
  p_value <- Anova(model)[[3]]
  
  # Get R^2 values
  r2_values <- r.squaredGLMM(model)
  marginal_r2 <- r2_values[1]  # Marginal R^2
  conditional_r2 <- r2_values[2]  # Conditional R^2
  
  # Get AIC values
  aic_value <- AIC(model)
  
  # Append results to the dataframe
  results <- rbind(results, 
                   data.frame(Variable = variable, 
                              P_Value = p_value, 
                              Marginal_R2 = marginal_r2, 
                              Conditional_R2 = conditional_r2,
                              AIC = aic_value))
}

# Display the results
print(results[order(results$AIC),])
```

#### Plot Significant Univariate Models
```{r}
linear_chl_pH_pac <- lmer(Chl_ug.cm.2 ~ Low_Tide_Mean_pH +
                                  (1|Genotype) + (1|Cage_Uncaged), 
                          data = PAC_model_data)

#prediction
prediction_data <- data.frame(Low_Tide_Mean_pH = seq(
  min(PAC_model_data$Low_Tide_Mean_pH),
  max(PAC_model_data$Low_Tide_Mean_pH),
  length.out = 100
))

# Add predicted values to the dataframe using the model without random effects
predictions <- predict(linear_chl_pH_pac, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

#annnotations
anova_results <- car::Anova(linear_chl_pH_pac)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_chl_pH_pac)
marginal_r2 <- r2_values[1]  # Marginal R^2
conditional_r2 <- r2_values[2]
aic_value <- AIC(linear_chl_pH_pac)

#predictions
pred_chl_pH <- ggpredict(linear_chl_pH_pac, terms = "Low_Tide_Mean_pH")

#plot
plot_chl_pH <- ggplot() +
  geom_point(aes(x = Low_Tide_Mean_pH, y = Chl_ug.cm.2, color = Genotype, shape = Cage_Uncaged), data = PAC_model_data) +
  labs(x = "Low Tide Mean pH", 
       y = expression(paste("Chlorophyll density (μg ", cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  scale_y_continuous(limits = c(0,4.5)) +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white")) +
  #CI
  geom_line(data = prediction_data, aes(x = Low_Tide_Mean_pH, y = fit), color = "#21908c") +  # Add the fitted line
  geom_ribbon(data = prediction_data, aes(x = Low_Tide_Mean_pH, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c")+
  #annotations
  annotate("text", y = 3, x = 8.02,
         label = paste("p =", round(p_values["Low_Tide_Mean_pH"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3),
                       "\nAIC =", round(aic_value,3)),
         hjust = 0, size = 3)

plot_chl_pH
#ggsave("output/pac_chl_pH_mod.png", plot_chl_pH, height = 7, width = 6)
```

```{r}
linear_chl_NN_pac <- lmer(Chl_ug.cm.2 ~ Low_Tide_Mean_NN_umolL +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)

#prediction
prediction_data <- data.frame(Low_Tide_Mean_NN_umolL = seq(
  min(PAC_model_data$Low_Tide_Mean_NN_umolL),
  max(PAC_model_data$Low_Tide_Mean_NN_umolL),
  length.out = 100
))

# Add predicted values to the dataframe using the model without random effects
predictions <- predict(linear_chl_NN_pac, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

#annnotations
anova_results <- car::Anova(linear_chl_NN_pac)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_chl_NN_pac)
  marginal_r2 <- r2_values[1]  # Marginal R^2
  conditional_r2 <- r2_values[2] 
  aic_value <- AIC(linear_chl_NN_pac)

plot_chl_NN <- ggplot() +
  geom_point(aes(x = Low_Tide_Mean_NN_umolL, y = Chl_ug.cm.2, color = Genotype, shape = Cage_Uncaged), data = PAC_model_data) +
  labs(x = "Low Tide Mean Nitrate + Nitrite (umolL)", 
       y = expression(paste("Chlorophyll density (μg ", cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  scale_y_continuous(limits = c(0,4.5)) +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white")) +
  #CI
  geom_line(data = prediction_data, aes(x = Low_Tide_Mean_NN_umolL, y = fit), color = "#21908c") +  
  geom_ribbon(data = prediction_data, aes(x = Low_Tide_Mean_NN_umolL, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c")+
  # annotation
  annotate("text", y = 0.5, x = 0.61,
         label = paste("p =", round(p_values["Low_Tide_Mean_NN_umolL"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3),
                       "\nAIC =", round(aic_value,3)),
         hjust = 0, size = 3)
plot_chl_NN
#ggsave("output/pac_chl_NN_mod.png", plot_chl_NN, height = 7, width = 6)
```

### Polynomial
```{r}
polynomial_chl_model_pac <- lmer(Chl_ug.cm.2 ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(polynomial_growth_model_pru)
Anova(polynomial_chl_model_pac)
```

```{r}
pred_chl_poly <- ggpredict(polynomial_chl_model_pac, terms = "pc1")

#annnotations
anova_results <- car::Anova(polynomial_chl_model_pac)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 

plot_chl <- ggplot() +
  # Raw data points
  geom_point(data = PAC_model_data, 
             aes(x = pc1, y = Chl_ug.cm.2), color = "grey50", alpha = 0.6) +
  # Prediction line with confidence interval
  geom_line(data = pred_chl_poly, aes(x = x, y = predicted), color = "#21908c") +
  geom_ribbon(data = pred_chl_poly, aes(x = x, ymin = conf.low, ymax = conf.high), 
              fill = "#21908c", alpha = 0.2) +
  scale_y_continuous(limits = c(-1.5,25)) +
  labs(
    x = "PC1",
    y = expression(paste("Chlorophyll density (μg ", cm^2, ")"))
  ) +
  custom_theme+
  annotate("text", y = 1, x = max(pred_chl_poly$x, na.rm=TRUE), 
           label = paste("p =", round(p_values["poly(pc1, 2)"], 6)), 
           hjust = 1.1, vjust = 1, size = 3)
```

```{r}
linear_chl_pac_growth <- lmer(Percent_Change ~ Chl_ug.cm.2 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)

plot_chl_growth <- ggplot() +
  # Raw data points
  geom_point(data = PAC_model_data, 
             aes(x = Chl_ug.cm.2, y = Percent_Change,
                 color= Genotype, shape = Cage_Uncaged)) +
  labs(
    y = "Percent Change in Buoyant Weight",
    x = expression(paste("Chlorophyll density (μg ", cm^2, ")"))
  ) +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1)+
  custom_theme+
  annotate("text", y = 1, x = 1, 
           label = "p =0.1516", 
           hjust = 1.1, vjust = 1, size = 3)
```


## Porites rus
```{r}
pru_chl_raw <- ggplot(PRU_model_data, aes(x = pc1, y = Chl_ug.cm.2, color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PC1", 
       y = expression(paste("Chlorophyll density (μg ", cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pru_chl_raw

ggsave("output/pru_chl_nutrientpca_raw.png",pru_chl_raw, height = 5, width = 5.5)
```

### linear
```{r}
linear_chl_model_pru <- lmer(Chl_ug.cm.2 ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(linear_growth_model_pru)
Anova(linear_chl_model_pru)
```

### polynomial
```{r}
polynomial_chl_model_pru <- lmer(Chl_ug.cm.2 ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(polynomial_growth_model_pru)
Anova(polynomial_chl_model_pru)
```

## Caged only
### Pocillopora acuta
```{r}
linear_chl_model_pac_caged <- lmer(Chl_ug.cm.2 ~ pc1 +
                                  (1|Genotype), data = PAC_model_data %>% filter(Cage_Uncaged == "C"))
#check_model(linear_growth_model_pac)
Anova(linear_chl_model_pac_caged)
r2_values_caged <- r.squaredGLMM(linear_chl_model_pac_caged)
marginal_r2_caged <- r2_values[1]  # Marginal R^2
conditional_r2_caged <- r2_values[2]
```
#### Plot caged significant model
```{r}
pred_chl <- ggpredict(linear_chl_model_pac_caged, terms = "pc1")

#annnotations
anova_results <- car::Anova(linear_chl_model_pac_caged)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_chl_model_pac_caged)
  marginal_r2_caged <- r2_values[1]  # Marginal R^2
  conditional_r2_caged <- r2_values[2] #Conditional r2

plot_chl_caged <- ggplot() +
  # Raw data points
  geom_point(data = PAC_model_data%>% filter(Cage_Uncaged == "C"), 
             aes(x = pc1, y = Chl_ug.cm.2, color = Genotype), alpha = 0.6) +
  # Prediction line with confidence interval
  geom_line(data = pred_chl, aes(x = x, y = predicted), color = "#21908c") +
  geom_ribbon(data = pred_chl, aes(x = x, ymin = conf.low, ymax = conf.high), 
              fill = "#21908c", alpha = 0.2) +
  scale_y_continuous(limits = c(0,4.5)) +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  labs(
    x = "PC1",
    y = expression(paste("Chlorophyll density (μg ", cm^2, ")"))
  ) +
  custom_theme+
  annotate("text", y = 0.5, x = max(pred_chl$x, na.rm = TRUE), 
         label = paste("p =", round(p_values["pc1"], 6), 
                       "\nMarginal R² =", round(marginal_r2_caged, 3), 
                       "\nConditional R² =", round(conditional_r2_caged, 3)), 
         hjust = 1.1, vjust = 1, size = 3)

plot_chl_caged
```
#### Investigate Univariate Models
```{r}
# Define the data and random effects
random_effects <- "(1|Genotype)"

# Define the predictors
predictors <- c("Low_Tide_Mean_Salinity", "Low_Tide_Mean_NN_umolL", 
                "Low_Tide_Mean_Phosphate_umolL", "Low_Tide_Mean_Silicate_umolL", 
                "Low_Tide_Mean_TA", "Low_Tide_Mean_pH")

predictors <- pulse_columns

# Initialize a results dataframe
results <- data.frame(Variable = character(), 
                      P_Value = numeric(), 
                      Marginal_R2 = numeric(), 
                      Conditional_R2 = numeric(),
                      AIC = numeric(),
                      stringsAsFactors = FALSE)

# Loop through each predictor
for (variable in predictors) {
  # Construct the formula dynamically
  formula <- as.formula(paste("Chl_ug.cm.2 ~", variable, "+", random_effects))
  
  # Fit the model
  model <- lmer(formula, data = PAC_model_data_caged_only)
  
  # Get the p-value from Anova()
  p_value <- Anova(model)[[3]]
  
  # Get R^2 values
  r2_values <- r.squaredGLMM(model)
  marginal_r2 <- r2_values[1]  # Marginal R^2
  conditional_r2 <- r2_values[2]  # Conditional R^2
  
  # Get AIC values
  aic_value <- AIC(model)
  
  # Append results to the dataframe
  results <- rbind(results, 
                   data.frame(Variable = variable, 
                              P_Value = p_value, 
                              Marginal_R2 = marginal_r2, 
                              Conditional_R2 = conditional_r2,
                              AIC = aic_value))
}

# Display the results
print(results[order(results$AIC),])
```
##### Plot significant univariate models
```{r}
linear_chl_pH_pac_caged <- lmer(Chl_ug.cm.2 ~ Low_Tide_Mean_pH +
                                  (1|Genotype), 
                          data = PAC_model_data_caged_only)

#annnotations
anova_results <- car::Anova(linear_chl_pH_pac_caged)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_chl_pH_pac_caged)
marginal_r2 <- r2_values[1]  # Marginal R^2
conditional_r2 <- r2_values[2]
aic_value <- AIC(linear_chl_pH_pac_caged)

#predictions
pred_chl_pH_caged <- ggpredict(linear_chl_pH_pac_caged, terms = "Low_Tide_Mean_pH")

#plot
plot_chl_pH_caged <- ggplot() +
  geom_point(aes(x = Low_Tide_Mean_pH, y = Chl_ug.cm.2, color = Genotype), data = PAC_model_data_caged_only) +
  labs(x = "Low Tide Mean pH", 
       y = expression(paste("Chlorophyll density (μg ", cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  scale_y_continuous(limits = c(0,4.5)) +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") +
  geom_line(data = pred_chl_pH_caged, aes(x = x, y = predicted), color = "#21908c") +
  geom_ribbon(data = pred_chl_pH_caged, aes(x = x, ymin = conf.low, ymax = conf.high),
              fill = "#21908c", alpha = 0.2)+
  annotate("text", y = 0.5, x = max(pred_chl_pH_caged$x, na.rm = TRUE),
         label = paste("p =", round(p_values["Low_Tide_Mean_pH"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3),
                       "\nAIC = ", round(aic_value,3)),
         hjust = 1.1, vjust = 0.5, size = 3)

plot_chl_pH_caged
#ggsave("output/pac_chl_pH_mod_caged.png", plot_chl_pH_caged, height = 5, width = 5.5)
```

Phosphate:
```{r}
linear_chl_po4_pac_caged <- lmer(Chl_ug.cm.2 ~ Low_Tide_Mean_Phosphate_umolL +
                                  (1|Genotype), 
                          data = PAC_model_data_caged_only)

#annnotations
anova_results <- car::Anova(linear_chl_po4_pac_caged)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_chl_po4_pac_caged)
marginal_r2 <- r2_values[1]  # Marginal R^2
conditional_r2 <- r2_values[2]
aic_value <- AIC(linear_chl_po4_pac_caged)

#predictions
pred_chl_po4_caged <- ggpredict(linear_chl_po4_pac_caged, terms = "Low_Tide_Mean_Phosphate_umolL")

#plot
plot_chl_p04_caged <- ggplot() +
  geom_point(aes(x = Low_Tide_Mean_Phosphate_umolL, y = Chl_ug.cm.2, color = Genotype), data = PAC_model_data_caged_only) +
  labs(x = "Low Tide Mean Phosphate (umol/L)", 
       y = expression(paste("Chlorophyll density (μg ", cm^2, ")")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  scale_y_continuous(limits = c(0,4.5)) +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") +
  geom_line(data = pred_chl_po4_caged, aes(x = x, y = predicted), color = "#21908c") +
  geom_ribbon(data = pred_chl_po4_caged, aes(x = x, ymin = conf.low, ymax = conf.high),
              fill = "#21908c", alpha = 0.2)+
  annotate("text", y = 0.5, x = max(pred_chl_po4_caged$x, na.rm = TRUE),
         label = paste("p =", round(p_values["Low_Tide_Mean_pH"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3),
                       "\nAIC = ", round(aic_value,3)),
         hjust = 1.1, vjust = 0.8, size = 3)

plot_chl_p04_caged
#ggsave("output/pac_chl_pH_mod.png", plot_chl_pH, height = 5, width = 5.5)
```
# Photosynthetic Efficiency
So, we have chlorophyll and we have symbiont - we want to know if chlorophyll is increasing per cm2 because the cells are increasing, or because the chlopohyll per cell is increasing.
```{r}
PAC_model_data$pe <- PAC_model_data$Chl_ug.cm.2 / PAC_model_data$FSC.Events_per_cm_2 
PRU_model_data$pe <- PRU_model_data$Chl_ug.cm.2 / PRU_model_data$FSC.Events_per_cm_2 
#there's a major outlier
PRU_model_data <- PRU_model_data %>%
  mutate(pe = if_else(pe < 0.0010526, pe, NA_real_))
```

## Pocillopora acuta
### exploratory plot
```{r}
pac_pe_raw <- ggplot(PAC_model_data, aes(x = pc1, y = log10(pe), color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(
    x = "PC1",
    y = "Photosynthetic efficiency",
    title = " "
    #title = expression(italic("Pocillopora acuta") ~ "Change in Buoyant Weight by Nutrient Pulses")
  ) +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pac_pe_raw
```

### Model:
```{r}
linear_pe_model_pac <- lmer(log10(pe) ~ pc1 + (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data) #needs a log10 transformation
check_model(linear_pe_model_pac)
summary(linear_pe_model_pac)
Anova(linear_pe_model_pac)
```

```{r}
# Define the data and random effects
random_effects <- "(1|Genotype) + (1|Cage_Uncaged)"

# Define the predictors
predictors <- pulse_columns

# Initialize a results dataframe
results <- data.frame(Variable = character(), 
                      P_Value = numeric(), 
                      Marginal_R2 = numeric(), 
                      Conditional_R2 = numeric(),
                      AIC = numeric(),
                      stringsAsFactors = FALSE)

# Loop through each predictor
for (variable in predictors) {
  # Construct the formula dynamically
  formula <- as.formula(paste("log10(pe) ~", variable, "+", random_effects))
  
  # Fit the model
  model <- lmer(formula, data = PAC_model_data)
  
  # Get the p-value from Anova()
  p_value <- Anova(model)[[3]]
  
  # Get R^2 values
  r2_values <- r.squaredGLMM(model)
  marginal_r2 <- r2_values[1]  # Marginal R^2
  conditional_r2 <- r2_values[2]  # Conditional R^2
  
  # Get AIC values
  aic_value <- AIC(model)
  
  # Append results to the dataframe
  results <- rbind(results, 
                   data.frame(Variable = variable, 
                              P_Value = p_value, 
                              Marginal_R2 = marginal_r2, 
                              Conditional_R2 = conditional_r2,
                              AIC = aic_value))
}

# Display the results
print(results[order(results$AIC),])
```



## Porites rus
### exploratory plot
```{r}
pru_pe_raw <- ggplot(PRU_model_data, aes(x = pc1, y = log10(pe), color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(
    x = "PC1",
    y = "Photosynthetic efficiency",
    title = " "
    #title = expression(italic("Pocillopora acuta") ~ "Change in Buoyant Weight by Nutrient Pulses")
  ) +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pru_pe_raw
```

### linear model
```{r}
linear_pe_model_pru <- lmer(log10(pe) ~ pc1 + (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(linear_carbon_model_pac)
#summary(linear_carbon_model_pac)
Anova(linear_pe_model_pru)
```


# Heterotrophy
## Carbon

### Pocillopora acuta

#### Exploratory plot:
```{r}
SI_PAC_model_data <- PAC_model_data %>% 
  filter(!is.na(Δ13C))
ggplot(data = SI_PAC_model_data, (aes(y=Δ13C, x= pc1))) +
         geom_point()

pac_13C_raw <- ggplot(PAC_model_data %>% 
  filter(!is.na(Δ13C)), aes(x = pc1, y = Δ13C, color = Genotype)) +
  geom_point() +
  labs(x = "PC1", 
       y = "δ13C",
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pac_13C_raw

ggsave("output/pac_13C_nutrientpca_raw.png",pac_13C_raw, height = 5, width = 5.5)
```

#### Linear model:
```{r}
linear_carbon_model_pac <- lmer(Δ13C ~ pc1 +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(linear_carbon_model_pac)
#summary(linear_carbon_model_pac)
Anova(linear_carbon_model_pac)
```
Not significant

#### Polynomial model:
```{r}
polynomial_carbon_model_pac <- lmer(Δ13C ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(polynomial_carbon_model_pac)
Anova(polynomial_carbon_model_pac)
```
Not significant

### Porites rus
#### Exploratory plot:
```{r}
SI_PRU_model_data <- PRU_model_data %>% 
  filter(!is.na(Δ13C))
ggplot(data = SI_PRU_model_data, (aes(y=Δ13C, x= pc1))) +
         geom_point()

pru_13C_raw <- ggplot(PRU_model_data %>% 
  filter(!is.na(Δ13C)), aes(x = pc1, y = Δ13C, color = Genotype)) +
  geom_point() +
  labs(x = "PC1", 
       y = "δ13C",
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pru_13C_raw

ggsave("output/pru_13C_nutrientpca_raw.png",pru_13C_raw, height = 5, width = 5.5)
```

#### Linear model:
```{r}
linear_carbon_model_PRU <- lmer(Δ13C ~ pc1 +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(linear_carbon_model_PRU)
#summary(linear_carbon_model_PRU)
Anova(linear_carbon_model_PRU)
```
Not significant

#### Polynomial model:
```{r}
polynomial_carbon_model_PRU <- lmer(Δ13C ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(polynomial_carbon_model_PRU)
Anova(polynomial_carbon_model_PRU)
```
Not significant

## Nitrogen

### Pocillopora acuta

#### Exploratory plot:
```{r}
SI_PAC_model_data <- PAC_model_data %>% 
  filter(!is.na(Δ15N))

pac_15N_raw <- ggplot(PAC_model_data %>% 
  filter(!is.na(Δ13C)), aes(x = pc1, y = Δ13C, color = Genotype)) +
  geom_point() +
  labs(x = "PC1", 
       y = "δ15N",
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pac_15N_raw

ggsave("output/pac_15N_nutrientpca_raw.png",pac_15N_raw, height = 5, width = 5.5)
```

#### Linear model:
```{r}
linear_nitrogen_model_pac <- lmer(Δ15N ~ pc1 +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(linear_nitrogen_model_pac)
#summary(linear_nitrogen_model_pac)
Anova(linear_nitrogen_model_pac)
```
Significant!!!

##### Plot significant model

```{r}
linear_nitrogen_model_pac <- lmer(Δ15N ~ pc1 +
                                  (1|Genotype), data = SI_PAC_model_data)
prediction_data <- data.frame(pc1 = seq(
  min(SI_PAC_model_data$pc1),
  max(SI_PAC_model_data$pc1),
  length.out = 100
))

#annnotations
anova_results <- car::Anova(linear_nitrogen_model_pac)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_nitrogen_model_pac)
marginal_r2 <- r2_values[1]  # Marginal R^2
conditional_r2 <- r2_values[2]
aic_value <- AIC(linear_nitrogen_model_pac)

# Add predicted values to the dataframe using the model without random effects
predictions <- predict(linear_nitrogen_model_pac, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

#plot
plot_15N_pc1 <- ggplot() +
  #points
  geom_point(aes(x = pc1, y = Δ15N, color = Genotype), data = SI_PAC_model_data) +
  labs(x = "PC1", 
       y = expression(paste("Δ15N (host minus symbiont)")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal() +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white")) +
  #line and ribbon
  geom_line(data = prediction_data, aes(x = pc1, y = fit), color = "#21908c") +  # Add the fitted line
  geom_ribbon(data = prediction_data, aes(x = pc1, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c") +
  #annotations
  annotate("text", y = -0.2, x = 2,
         label = paste("p =", round(p_values["pc1"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3)),
         hjust = 0, size = 3)

plot_15N_pc1
#ggsave("output/pac_15N_pca_mod.png", plot_15N_pc1, height = 7, width = 6)
```
##### Investigate Univariate Models
```{r}
# Define the data and random effects
random_effects <- "(1|Genotype)"

# Define the predictors
predictors <- pulse_columns

# Initialize a results dataframe
results <- data.frame(Variable = character(), 
                      P_Value = numeric(), 
                      Marginal_R2 = numeric(), 
                      Conditional_R2 = numeric(),
                      AIC = numeric(),
                      stringsAsFactors = FALSE)

# Loop through each predictor
for (variable in predictors) {
  # Construct the formula dynamically
  formula <- as.formula(paste("Δ15N ~", variable, "+", random_effects))
  
  # Fit the model
  model <- lmer(formula, data = SI_PAC_model_data)
  
  # Get the p-value from Anova()
  p_value <- Anova(model)[[3]]
  
  # Get R^2 values
  r2_values <- r.squaredGLMM(model)
  marginal_r2 <- r2_values[1]  # Marginal R^2
  conditional_r2 <- r2_values[2]  # Conditional R^2
  
  # Get AIC values
  aic_value <- AIC(model)
  
  # Append results to the dataframe
  results <- rbind(results, 
                   data.frame(Variable = variable, 
                              P_Value = p_value, 
                              Marginal_R2 = marginal_r2, 
                              Conditional_R2 = conditional_r2,
                              AIC = aic_value))
}

# Display the results
print(results[order(results$AIC),])
```
####### Best univariate model

```{r}
#model
linear_nitrogen_model_pac_po4 <- lmer(Δ15N ~ Low_Tide_Mean_Phosphate_umolL +
                                  (1|Genotype), data = SI_PAC_model_data)

#prediction
prediction_data <- data.frame(Low_Tide_Mean_Phosphate_umolL = seq(
  min(SI_PAC_model_data$Low_Tide_Mean_Phosphate_umolL),
  max(SI_PAC_model_data$Low_Tide_Mean_Phosphate_umolL),
  length.out = 100
))

# Add predicted values to the dataframe using the model without random effects
predictions <- predict(linear_nitrogen_model_pac_po4, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

#annnotations
anova_results <- car::Anova(linear_nitrogen_model_pac_po4)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_nitrogen_model_pac_po4)
marginal_r2 <- r2_values[1]  # Marginal R^2
conditional_r2 <- r2_values[2]
aic_value <- AIC(linear_nitrogen_model_pac_po4)

# Create the plot with the fitted line
plot_15N_po4 <-ggplot() +
  geom_point(aes(x = Low_Tide_Mean_Phosphate_umolL, y = Δ15N, color = Genotype), data = SI_PAC_model_data) +
  labs(x = "Low_Tide_Mean_Phosphate_umolL", 
       y = expression(paste("Δ15N (host minus symbiont)")),
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  #add in line and ribbon
  geom_line(data = prediction_data, aes(x = Low_Tide_Mean_Phosphate_umolL, y = fit), color = "#21908c") +  # Add the fitted line
  geom_ribbon(data = prediction_data, aes(x = Low_Tide_Mean_Phosphate_umolL, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c") +  # Add CI
  labs(title = " ",
       x = "Low Tide Mean Phosphate (umolL)",
       y = "Δ15N") +
  annotate("text", y = 0.5, x = 0.21,
         label = paste("p =", round(p_values["Low_Tide_Mean_Phosphate_umolL"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3),
                       "\nAIC =", round(aic_value,3)),
         hjust = 0, vjust = -1, size = 3) +
  theme_minimal() +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white"))

plot_15N_po4
#ggsave("output/pac_15N_p04_mod.png", plot_15N_po4, height = 7, width = 6)
```

But, we're talking about nitrogen, so lets look at the n sources
```{r}
#model
linear_nitrogen_model_pac_NN <- lmer(Δ15N ~ Low_Tide_Mean_NN_umolL +
                                  (1|Genotype), data = SI_PAC_model_data)

#prediction
prediction_data <- data.frame(Low_Tide_Mean_NN_umolL = seq(
  min(SI_PAC_model_data$Low_Tide_Mean_NN_umolL),
  max(SI_PAC_model_data$Low_Tide_Mean_NN_umolL),
  length.out = 100
))

# Add predicted values to the dataframe using the model without random effects
predictions <- predict(linear_nitrogen_model_pac_NN, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

#annnotations
anova_results <- car::Anova(linear_nitrogen_model_pac_NN)
p_values <- anova_results$`Pr(>Chisq)`[1]  # Adjust index based on your model's fixed effects
names(p_values) <- rownames(anova_results)[1] 
r2_values <- r.squaredGLMM(linear_nitrogen_model_pac_NN)
marginal_r2 <- r2_values[1]  # Marginal R^2
conditional_r2 <- r2_values[2]
aic_value <- AIC(linear_nitrogen_model_pac_NN)

# Create the plot with the fitted line
plot_15N_NN <-ggplot() +
  geom_point(aes(x = Low_Tide_Mean_NN_umolL, y = Δ15N, color = Genotype), data = SI_PAC_model_data) +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  #add in line and ribbon
  geom_line(data = prediction_data, aes(x = Low_Tide_Mean_NN_umolL, y = fit), color = "#21908c") +  # Add the fitted line
  geom_ribbon(data = prediction_data, aes(x = Low_Tide_Mean_NN_umolL, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c") +  # Add CI
  labs(title = " ",
       x = "Low Tide Mean NN (umolL)",
       y = "Δ15N") +
  annotate("text", y = 0, x = 0.21,
         label = paste("p =", round(p_values["Low_Tide_Mean_NN_umolL"], 6),
                       "\nMarginal R² =", round(marginal_r2, 3),
                       "\nConditional R² =", round(conditional_r2, 3),
                       "\nAIC =", round(aic_value,3)),
         hjust = 0, vjust = -1, size = 3) +
  theme_minimal() +
  theme(legend.position="bottom",
        plot.background = element_rect(fill = "white"))

plot_15N_NN
#ggsave("output/pac_15N_p04_mod.png", plot_15N_NN, height = 7, width = 6)
```


##### Looking at H or S
```{r}
linear_nitrogen_host_model_pac <- lmer(δ15N_host ~ pc1 +
                                  (1|Genotype), data = SI_PAC_model_data)
Anova(linear_nitrogen_host_model_pac)
```
```{r}
linear_nitrogen_symb_model_pac <- lmer(δ15N_symb ~ pc1 +
                                  (1|Genotype), data = SI_PAC_model_data)
Anova(linear_nitrogen_symb_model_pac)
```
wow. that's craZy. neither are significantly changing, but their relationship to each other is?
what if we filter out those super low ones:
```{r}
linear_nitrogen_filtered_model_pac <- lmer(Δ15N ~ pc1 +
                                  (1|Genotype), 
                                  data = SI_PAC_model_data %>% filter(Δ15N >0))
Anova(linear_nitrogen_filtered_model_pac)
```
nope, still significant

#### Polynomial model:
```{r}
polynomial_nitrogen_model_pac <- lmer(Δ15N ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(polynomial_nitrogen_model_pac)
Anova(polynomial_nitrogen_model_pac)
```
Significant

### Porites rus
#### Exploratory plot:
```{r}
SI_PRU_model_data <- PRU_model_data %>% 
  filter(!is.na(Δ15N))
ggplot(data = SI_PRU_model_data, (aes(y=Δ15N, x= pc1))) +
         geom_point()

pru_15N_raw <- ggplot(PRU_model_data %>% 
  filter(!is.na(Δ13C)), aes(x = pc1, y = Δ13C, color = Genotype)) +
  geom_point() +
  labs(x = "PC1", 
       y = "δ15N",
      title = " ") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()+
  theme(legend.position="none",
        plot.background = element_rect(fill = "white")) +
  guides(color = "none", shape = "none") 

pru_15N_raw

ggsave("output/pru_15N_nutrientpca_raw.png",pru_15N_raw, height = 5, width = 5.5)
```

#### Linear model:
```{r}
linear_nitrogen_model_PRU <- lmer(Δ15N ~ pc1 +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(linear_nitrogen_model_PRU)
#summary(linear_nitrogen_model_PRU)
Anova(linear_nitrogen_model_PRU)
```
Not significant

#### Polynomial model:
```{r}
polynomial_nitrogen_model_PRU <- lmer(Δ15N ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(polynomial_nitrogen_model_PRU)
Anova(polynomial_nitrogen_model_PRU)
```
Significant

```{r}
prediction_data <- data.frame(pc1 = seq(min(SI_PRU_model_data$pc1), 
                                   max(SI_PRU_model_data$pc1), 
                                   length.out = 100))
# Add predicted values to the dataframe using the model without random effects
predictions <- predict(polynomial_nitrogen_model_PRU, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

# Create the plot with the fitted line
ggplot() +
  geom_point(data = SI_PRU_model_data, aes(x = pc1, y = Δ15N), color = "grey") +
  geom_line(data = prediction_data, aes(x = pc1, y = fit), color = "#21908c") +  # Add the fitted line
  geom_ribbon(data = prediction_data, aes(x = pc1, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c") +  # Add CI
  labs(title = "Porites rus Δ15N (host minus symbiont, proxy for heterotrophy)",
       x = "PC1",
       y = "Δ15N") +
  theme_minimal()
```


```{r}
# Perform ANOVA on the linear mixed model
anova_results <- anova(linear_pe_model_pru)

# Display the results
print(anova_results)

# Extract specific values
p_value <- anova_results$`Pr(>F)`[1]
num_df <- anova_results$Df[1]
den_df <- anova_results$DenDF[1]
f_stat <- anova_results$`F value`[1]

cat("p-value:", p_value, "\n")
cat("NumDF:", num_df, "\n")
cat("DenDF:", den_df, "\n")
cat("F-statistic:", f_stat, "\n")

```

