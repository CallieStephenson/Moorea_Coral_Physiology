---
title: "Nutrient Analysis"
author: "Callie Stephenson"
date: "2024-12-03"
output: html_document
---
# Set-up

load libraries
```{r}
library(dplyr)
library(lme4)
library(car)
library(ggplot2)
library(fishualize)
library(corrplot)
library(PerformanceAnalytics)
```

load data
```{r}
response_data <- read.csv("data/T1_response_data.csv")
all_nut <- read.csv("data/All_Nutrients_Processed.csv")
```

model data
```{r}
model_data <- left_join(response_data, explanatory_variables, by = join_by(CowTagID))

PAC_model_data <- model_data %>%
  filter(Species == "Pocillopora acuta", !is.na(Pin_Number))

PRU_model_data <- model_data %>%
  filter(Species == "Porites rus", !is.na(Pin_Number))

PRU_model_data_caged_only <- PRU_model_data %>% 
  filter(Cage_Uncaged == "C")
```

# PCA
Remove seep:
```{r}
nut_no_seep <- all_nut[all_nut$CowTagID != 'VSEEP',]
pulse_columns <- names(all_nut)[grepl("Low_Tide_Mean_", names(all_nut)) & 
                            !grepl("Temperature|pH|Ammonia_umol|TA",names(all_nut))]
nut_no_seep_scaled <- nut_no_seep %>%
  mutate(across(all_of(pulse_columns), scale))
```

Look at correlation between variables:
```{r}
pulse_df <- as.data.frame(lapply(nut_no_seep_scaled[, c(pulse_columns)], as.numeric))
cor_matrix <- cor(pulse_df)
corrplot(cor_matrix, method = "number")
chart.Correlation(pulse_df)
```

PCA:
```{r}
pca.data <- na.omit(nut_no_seep_scaled[, c(pulse_columns)]) 
pca = princomp(pca.data, cor=TRUE)
```

When we make a PCA of 
```{r}
names(pca.data)
```

we can explain 72.2% of the variation of these factors with 1 axis. 
```{r}
summary(pca)
loadings(pca)
```

```{r}
biplot(pca)
```

```{r autoplot}
# pca_plot <- autoplot(pca, loadings = TRUE, loadings.colour = '#47c16e',
#                       loadings.label = TRUE, loadings.label.size = 3, loadings.label.colour = '#47c16e') +
#  labs(
#     title = "Principal Component Analysis of Nutrient Data",
#     x = "Principal Component 1 (72.249%)",
#     y = "Principal Component 2 (15.019%)"
#   ) +
#   xlim(-2.5,4)+
# #  scale_x_reverse(-0.5,0.5) +
#   theme_minimal(base_size = 15) +  # Clean theme
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),  # Center title
#     axis.title = element_text(size = 12)
#   )
# 
# pca_plot
#ggsave(pca_plot, filename = "PCA_Plot.png", dpi = 600, width = 7, height = 5)
```

```{r}
scores <- as.data.frame(pca$scores)
loadings <- as.data.frame(pca$loadings[, 1:2])  # First two components

pca_plot <- ggplot(scores, aes(x = Comp.1, y = Comp.2)) +
  geom_point() +
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = 3*Comp.1, yend = 3*Comp.2),
               arrow = arrow(length = unit(0.2, "cm")), color = '#47c16e') +
  geom_text(data = loadings, aes(x = 3*Comp.1, y = 3*Comp.2, label = rownames(loadings)),
            color = '#47c16e', hjust = -0.2) +
  labs(
    title = "Principal Component Analysis of Nutrient Data",
    x = "Principal Component 1",
    y = "Principal Component 2"
  ) +
  theme_minimal(base_size = 15) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
    axis.title = element_text(size = 12)
  )

pca_plot
#ggsave(pca_plot, filename = "PCA_Plot.png", dpi = 600, width = 7, height = 5)
```

```{r}
nut_no_seep_scaled$pc1 = (pca$scores[,1]) #what's this data's score on pc1 axis
nut_no_seep_scaled$pc2 = (pca$scores[,2]) #what's this data's score on pc1 axis
```

```{r}
nut_no_seep$pc1 = (pca$scores[,1])
```

```{r}
sd_columns <- names(all_nut)[grepl("sd_", names(all_nut)) & 
                              !grepl("Phosphate_umolL|NN_umolL|Ammonia_umolL|NNP_umolL|Silicate_umolL",names(all_nut))]
```

```{r}
explanatory_variables <- nut_no_seep[,c("CowTagID", "pc1", pulse_columns, sd_columns)]
#write.csv(explanatory_variables, "data/explanatory_variables.csv")
```

# Growth

## P. acuta

### plot raw
```{r}
ggplot(PAC_model_data, aes(x = pc1, y = Percent_Change, color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PCA - low numbers reflect high SGD influence", y = "Percent Change in Buoyant Weight", title = "Pocillopora acuta change in buoyant weight by SGD exposure") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()
```

### linear
```{r}
linear_growth_model_pac <- lmer(Percent_Change ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(linear_growth_model_pac)
#summary(linear_growth_model_pac)
Anova(linear_growth_model_pac)
```

This model does not support the hypothesis that nutriencts from SGD contribute to the variance in calcification in Pocillopora acuta


### polynomial model: 

```{r}
polynomial_growth_model_pac <- lmer(log10(Percent_Change) ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(polynomial_growth_model_pac)
Anova(polynomial_growth_model_pac)
```

This model does not support the hypothesis that nutriencts from SGD contribute to the variance in calcification in Pocillopora acuta

## P. rus

### plot raw
```{r}
ggplot(PRU_model_data, aes(x = pc1, y = Percent_Change, color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PCA - low numbers reflect high SGD influence", y = "Percent Change in Buoyant Weight", title = "Porites rus change in buoyant weight by SGD exposure") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()
```

### linear
```{r}
linear_growth_model_pru <- lmer(Percent_Change ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(linear_growth_model_pru)
Anova(linear_growth_model_pru)
```

We do not find support for pc1 affecting growth of Porites rus in a linear fashion

### polynomial
```{r}
polynomial_growth_model_pru <- lmer(Percent_Change ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(polynomial_growth_model_pru)
Anova(polynomial_growth_model_pru)
```
We do not find support for pc1 affecting growth of Porites rus in a polynomial fashion

## Caged P. rus only

I also ran these models on a dataset with only caged corals:

### linear
```{r}
linear_growth_model_pru_c <- lmer(Percent_Change ~ pc1 +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(linear_growth_model_pru_c)
Anova(linear_growth_model_pru_c)
```

### polynomial
```{r}
polynomial_growth_model_pru_c <- lmer(Percent_Change ~ poly(pc1, 2) +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(polynomial_growth_model_pru_c)
Anova(polynomial_growth_model_pru_c)
```

These model does not support the hypothesis that nutriencts from SGD contribute to the variance in calcification in Pocillopora acuta

When only looking at caged samples, we still don't find any influence of PC1 on calcification

# Symbiont Count

## Pocillopora acuta

```{r}
ggplot(PAC_model_data, aes(x = pc1, y = log10(FSC.Events_per_cm_2), color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PCA - low numbers reflect high SGD influence", y = "Log10 transformed Symbiont Abundance", title = "Pocillopora acuta change in buoyant weight by SGD exposure") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()
```

### linear model
```{r}
linear_symb_model_pac <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(linear_symb_model_pac)
Anova(linear_symb_model_pac)
```

This model does not support the hypothesis that nutriencts from SGD contribute to the variance in symbiont density in Pocillopora acuta

### polynomial model

```{r}
polynomial_symb_model_pac <- lmer(log10(FSC.Events_per_cm_2) ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PAC_model_data)
#check_model(polynomial_symb_model_pac)
Anova(polynomial_symb_model_pac)
```

This model does not support the hypothesis that nutriencts from SGD contribute to the variance in symbiont density in Pocillopora acuta

## Porites rus
```{r}
ggplot(PRU_model_data, aes(x = pc1, y = log10(FSC.Events_per_cm_2), color = Genotype, shape = Cage_Uncaged)) +
  geom_point() +
  labs(x = "PCA - low numbers reflect high SGD influence", y = "Log10 transformed Symbiont Abundance", title = "Porites rus change in buoyant weight by SGD exposure") +
  scale_color_fish_d(option = "Coryphaena_hippurus", direction = -1) +
  theme_minimal()
```

### linear model:

```{r}
linear_symb_model_pru <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(linear_symb_model_pru)
Anova(linear_symb_model_pru)
```

We do not find support for pc1 affecting symb of Porites rus in a linear fashion

### polynomial model:

```{r}
polynomial_symb_model_pru <- lmer(log10(FSC.Events_per_cm_2) ~ poly(pc1, 2) +
                                  (1|Genotype) + (1|Cage_Uncaged), data = PRU_model_data)
#check_model(polynomial_symb_model_pru)
Anova(polynomial_symb_model_pru)
```

We do not find support for pc1 affecting symb of Porites rus in a polynomial fashion

## Caged P. rus only

### linear

```{r}
linear_symb_model_pru_c <- lmer(log10(FSC.Events_per_cm_2) ~ pc1 +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(linear_symb_model_pru_c)
Anova(linear_symb_model_pru_c)
```

### polynomial
```{r}
polynomial_symb_model_pru_c <- lmer(log10(FSC.Events_per_cm_2) ~ poly(pc1, 2) +
                                  (1|Genotype), data = PRU_model_data_caged_only)
#check_model(polynomial_symb_model_pru_c)
Anova(polynomial_symb_model_pru_c)
```

This model does not support the hypothesis that nutrients from SGD contribute to the variance in symbiont density in Porites rus

# Heterotrophy
## Carbon

### Pocillopora acuta

#### Exploratory plot:
```{r}
SI_PAC_model_data <- PAC_model_data %>% 
  filter(!is.na(Δ13C))
ggplot(data = SI_PAC_model_data, (aes(y=Δ13C, x= pc1))) +
         geom_point()
```

#### Linear model:
```{r}
linear_carbon_model_pac <- lmer(Δ13C ~ pc1 +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(linear_carbon_model_pac)
#summary(linear_carbon_model_pac)
Anova(linear_carbon_model_pac)
```
Not significant

#### Polynomial model:
```{r}
polynomial_carbon_model_pac <- lmer(Δ13C ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(polynomial_carbon_model_pac)
Anova(polynomial_carbon_model_pac)
```
Not significant

### Porites rus
#### Exploratory plot:
```{r}
SI_PRU_model_data <- PRU_model_data %>% 
  filter(!is.na(Δ13C))
ggplot(data = SI_PRU_model_data, (aes(y=Δ13C, x= pc1))) +
         geom_point()
```

#### Linear model:
```{r}
linear_carbon_model_PRU <- lmer(Δ13C ~ pc1 +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(linear_carbon_model_PRU)
#summary(linear_carbon_model_PRU)
Anova(linear_carbon_model_PRU)
```
Not significant

#### Polynomial model:
```{r}
polynomial_carbon_model_PRU <- lmer(Δ13C ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(polynomial_carbon_model_PRU)
Anova(polynomial_carbon_model_PRU)
```
Not significant

## Nitrogen

### Pocillopora acuta

#### Exploratory plot:
```{r}
SI_PAC_model_data <- PAC_model_data %>% 
  filter(!is.na(Δ15N))
ggplot(data = SI_PAC_model_data, (aes(y=Δ15N, x= pc1))) +
         geom_point()
```

#### Linear model:
```{r}
linear_nitrogen_model_pac <- lmer(Δ15N ~ pc1 +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(linear_nitrogen_model_pac)
#summary(linear_nitrogen_model_pac)
Anova(linear_nitrogen_model_pac)
```
Not significant

#### Polynomial model:
```{r}
polynomial_nitrogen_model_pac <- lmer(Δ15N ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PAC_model_data)
#check_model(polynomial_nitrogen_model_pac)
Anova(polynomial_nitrogen_model_pac)
```
Not significant

### Porites rus
#### Exploratory plot:
```{r}
SI_PRU_model_data <- PRU_model_data %>% 
  filter(!is.na(Δ15N))
ggplot(data = SI_PRU_model_data, (aes(y=Δ15N, x= pc1))) +
         geom_point()
```

#### Linear model:
```{r}
linear_nitrogen_model_PRU <- lmer(Δ15N ~ pc1 +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(linear_nitrogen_model_PRU)
#summary(linear_nitrogen_model_PRU)
Anova(linear_nitrogen_model_PRU)
```
Not significant

#### Polynomial model:
```{r}
polynomial_nitrogen_model_PRU <- lmer(Δ15N ~ poly(pc1, 2) +
                                  (1|Genotype), data = SI_PRU_model_data)
#check_model(polynomial_nitrogen_model_PRU)
Anova(polynomial_nitrogen_model_PRU)
```
Significant

```{r}
prediction_data <- data.frame(pc1 = seq(min(SI_PRU_model_data$pc1), 
                                   max(SI_PRU_model_data$pc1), 
                                   length.out = 100))
# Add predicted values to the dataframe using the model without random effects
predictions <- predict(polynomial_nitrogen_model_PRU, newdata = prediction_data, re.form = NA, se.fit = TRUE)

#Add to new_data
prediction_data <- prediction_data %>%
  mutate(fit = predictions$fit,
         se.fit = predictions$se.fit,
         lower = fit - 1.96 * se.fit,  # 95% CI lower
         upper = fit + 1.96 * se.fit)   # 95% CI upper

# Create the plot with the fitted line
ggplot() +
  geom_point(data = SI_PRU_model_data, aes(x = pc1, y = Δ15N), color = "grey") +
  geom_line(data = prediction_data, aes(x = pc1, y = fit), color = "#21908c") +  # Add the fitted line
  geom_ribbon(data = prediction_data, aes(x = pc1, ymin = lower, ymax = upper), alpha = 0.2, fill = "#21908c") +  # Add CI
  labs(title = "Porites rus Δ15N (host minus symbiont, proxy for heterotrophy)",
       x = "PC1",
       y = "Δ15N") +
  theme_minimal()
```